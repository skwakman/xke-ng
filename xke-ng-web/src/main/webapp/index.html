<!DOCTYPE html>
<html>
<head>
<title>Xebia Knowledge Exchange (NG)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="shortcut icon" href="images/netherlands_favicon.ico" type="image/x-icon" />

<link rel="stylesheet" href="static/jquery.mobile-1.0.1.min.css" />
<link rel="stylesheet" href="static/jquery.rating.css" />
<script type="text/javascript" src="static/jquery-1.6.4.min.js"></script>
<script type="text/javascript" src="static/jquery.rating.js"></script>
<script type="text/javascript" src="static/jquery.rating.pack.js"></script>
<script type="text/javascript" src="static/xkengmobile.js"></script>
<script type="text/javascript">
	
	GuiState = {};
	GuiState.currentSessionId;
	GuiState.currentConferenceId;
	GuiState.isNextConference = true;
	GuiState.forceSessionReload = false;

	function handleException(xhr, ajaxOptions, thrownError) {
		switch(xhr.status)
		{
		case 403:
			//alert("Please login")
			showLoginPage()
		  break;
		case 404:
			//alert("Cannot find requested object")
			changeToConferencePage(null, false)
		  break;
		default:
			alert("An unexpected error occured\nCode "
					+ xhr.status + "\nMessage "
					+ xhr.status);
			changeToConferencePage(null, false)
		}
	}
	
	
	ProxyAPI = {};
	ProxyAPI.loadConfById = function(confId, callback) {
		if(confId) {
			var selectedConf = LocalStorageAPI.getConf()
			if(selectedConf != null && selectedConf.id == confId) {
				console.log('load local conf: ' + conf.id)
				callback(selectedConf)
			} else {
				console.log('load remote conf')
				$.ajax({
					type : 'GET',
					dataType : 'json',
					contentType : 'application/json',
					url : '/xkeng/conference/'
							+ confId + '/slots',
					success : callback,
					crossDomain : false,
					error : handleException
	
			})
			}
		} else {
			console.log('load initial conf')
			$.ajax({
				type : 'GET',
				dataType : 'json',
				contentType : 'application/json',
				url : '/xkeng/conference/next/1/slots',
				success : callback,
				crossDomain : false,
				error : handleException
			})				
		}
	}
		
		ProxyAPI.loadSessionById = function(sessId, callback, forceReload) {
				var selectedSession = LocalStorageAPI.getSession(sessId)
				if(selectedSession && !forceReload) {
					console.log('load local session: ' + sessId)
					callback(selectedSession)
				} else {
					console.log('load remote session')
					var callbacks = function(session) {
						$.mobile.hidePageLoadingMsg();
						LocalStorageAPI.setSession(session)
			 			callback(session)
		 			}
					$.mobile.showPageLoadingMsg();
					$.ajax({
						type : 'GET',
						dataType : 'json',
						contentType : 'application/json',
						url : '/xkeng/session/' + sessId,
						success : callbacks,
						crossDomain : false,
						error : handleException
					})
				}
		}
	ProxyAPI.loadConfSummary = function(pastcount, futurecount) {
		$.ajax({
			type : 'GET',
			dataType : 'json',
			contentType : 'application/json',
			url : '/xkeng/conferences/summary/pastcount/' + pastcount + '/futurecount/' + futurecount,
			success : conferenceSummarySuccessCallback,
			crossDomain : false,
			error : handleException
		})
	}
	ProxyAPI.rateSession = function(sessId, rating, callback) {
		 var jsonRequest = {}
			jsonRequest.rate = rating;
			$.ajax({
				type : 'POST',
				dataType : 'json',
				contentType : 'application/json',
				url : '/xkeng/feedback/' + sessId + '/rating' ,
				success :  callback,
				crossDomain : false,
				data : JSON.stringify(jsonRequest),
				error : handleException
			});
	}
	
	
	$(document).bind("mobileinit", function(){
		//$.mobile.pageLoading();  
		//$(document).ready(
			$("#conf").live(
					"pageshow",
					function(event, ui) {
						ProxyAPI.loadConfById(GuiState.currentConferenceId, conferenceSuccessCallback)

	/* 					if(GuiState.currentConferenceId) {
							$.ajax({
								type : 'GET',
								dataType : 'json',
								contentType : 'application/json',
								url : '/xkeng/conference/'
										+ GuiState.currentConferenceId + '/slots',
								success : conferenceSuccessCallback,
								crossDomain : false,
								error : handleException

						})
						} else {
							$.ajax({
								type : 'GET',
								dataType : 'json',
								contentType : 'application/json',
								url : '/xkeng/conference/next/1/slots',
								success : conferenceSuccessCallback,
								crossDomain : false,
								error : handleException
							})						
							
						} */
					}),
			$("#detail").live(
					"pageshow",
					function(event, ui) {						
						cleanSessionDetails()
						ProxyAPI.loadSessionById(GuiState.currentSessionId, sessionSuccessCallback, GuiState.forceSessionReload)
						GuiState.forceSessionReload = false
/* 						$.ajax({
							type : 'GET',
							dataType : 'json',
							contentType : 'application/json',
							url : '/xkeng/session/' + GuiState.currentSessionId,
							success : sessionSuccessCallback,
							crossDomain : false,
							error : handleException
						})
 */					}),					
					$("#chooseConference").live(
							"pageshow",
							function(event, ui) {
								$.mobile.showPageLoadingMsg();
								ProxyAPI.loadConfSummary(3,5)
	/* 							$.ajax({
									type : 'GET',
									dataType : 'json',
									contentType : 'application/json',
									url : '/xkeng/conferences/summary/pastcount/3/futurecount/5',
									success : conferenceSummarySuccessCallback,
									crossDomain : false,
									error : handleException
								}) */
							})

	//);
							//$.mobile.pageLoading(true);  
	});


	function login() {
		var jsonRequest = {}
		jsonRequest.username = $("#username").val();
		jsonRequest.password = $("#password").val();
		$.ajax({
			type : 'POST',
			dataType : 'json',
			contentType : 'application/json',
			url : '/xkeng/login',
			success : loginSuccessCallback,
			crossDomain : false,
			data : JSON.stringify(jsonRequest),
			error : function(xhr, ajaxOptions, thrownError) {
				alert("Unable to post login\nCode " + xhr.status + "\nMessage "
						+ xhr.status);
			}
		});
	}

	 function rate() {
		 GuiState.forceSessionReload = true
		 var rating = parseInt($("#slider-0").val())
		 ProxyAPI.rateSession(GuiState.currentSessionId, rating, showSessionDetailsPage)
		/*  var jsonRequest = {}
		jsonRequest.rate = ;
		$.ajax({
			type : 'POST',
			dataType : 'json',
			contentType : 'application/json',
			url : '/xkeng/feedback/' + GuiState.currentSessionId + '/rating' ,
			success :  showSessionDetailsPage,
			crossDomain : false,
			data : JSON.stringify(jsonRequest),
			error : handleException
		}); */
	 }
	 

		function showLoginPage() {
			$.mobile.changePage("#login", {
				transition : "fade"
			});
		}	

	 
	function loginSuccessCallback(response) {
		$.mobile.changePage("#conf", {
			transition : "slidedown"
		});
	}

	
	function cleanSessionDetails() {
		$("#detail-list").empty()
		$("#rating-stars").empty()
		$("#rate-button").empty()		
		
	}

	function showSessionDetailsPage() {
		//cleanSessionDetails()
		$.mobile.changePage("#detail", {
			transition : "slide"
		});
	}

	function changeToSessionDetailsPage(id) {
		GuiState.currentSessionId = id;
		 showSessionDetailsPage()
	}
	
	function changeToConferencePage(id, next) {
		$("#summary-list").empty()
		GuiState.isNextConference = next
		GuiState.currentConferenceId = id
		$.mobile.changePage("#conf", {
			transition : "fade"
		});
	}

	function getAuthors(session) {
		var authors = ""
		for (authorIndex in session.authors) {
			if (authorIndex > 0) {
				authors += ", "
			}
			authors += session.authors[authorIndex].name
		}
		return authors;
	}

	function conferenceSummarySuccessCallback(conferences) {
		$.mobile.hidePageLoadingMsg();
		for (confIndex in conferences) {
			var conf = conferences[confIndex]
			var confTitle = getFormattedDate(conf.begin, "ddd, dd mmm yyyy") +  ' : '  + conf.title
			var next = false
			var liEl = "<li>"
			if(conf.next) {
				liEl = "<li data-theme='e'>"
				confTitle = "<i>" + confTitle + " </i><p class='ui-li-count'>NEXT</p>"
				next = true
			}
			$("#summary-list").append(
						liEl + "<a href='javascript:changeToConferencePage(\""
								+ conf.id + "\"," + next + ");'>" +confTitle +  "</a></li>")
		}
		$("#summary-list").listview("refresh");
	}
	
	function conferenceSuccessCallback(response) {
		GuiState.currentConferenceId = response.id
		LocalStorageAPI.setConf(response)
		
		$("#conf-list").empty()
		var confTitle = getFormattedDate(response.begin, "ddd, dd mmm yyyy") + ' : ' +response.title
		if(GuiState.isNextConference) {
			confTitle = 'NEXT: ' +  confTitle
		}
		$("#conf-title").html(confTitle)	
		for (slotIndex in response.slots) {
			var slot = response.slots[slotIndex]
			$("#conf-list").append(
					"<li data-role='list-divider'>" + slot.from + " - "
							+ slot.to + "</li>")
			for (sessionsIndex in slot.sessions) {
				var session = slot.sessions[sessionsIndex]
				var authors = getAuthors(session)
				$("#conf-list").append(
						"<li><a href='javascript:changeToSessionDetailsPage(\""
								+ session.id + "\");'><span><i>" + splitText(session.title, 32, '<br>')
								+ "</i></span><br><br><p>by: " + authors + "</p><span class='ui-li-aside'> "
								+ session.location.description + "&nbsp;&nbsp;&nbsp;</span></a></li>")
			}
		}
		$("#conf-list").listview("refresh");
	}


	function getRatingAverage(ratings) {
		if(ratings) {
			var total = 0	
			for(ratingIndex in ratings) {
				total += ratings[ratingIndex].rate
			}
			return parseInt(total / ratings.length);		
		}
		return 0;
	}

	function renderRatings(ratings) {
		var maxRating = 5
		var avgRating = Math.round(getRatingAverage(ratings) / 2)
		var ratingStars = "<div style='margin: auto 1.5em; display: inline-block;'>"
		for(var i = 0; i<maxRating; i++) {
			if(avgRating != 0 && i == (avgRating -1)) {
				ratingStars +="<input name='star1' type='radio' class='star' data-role='none' disabled='disabled' checked='checked' /> ";
			} else {
				ratingStars += "<input name='star1' type='radio' class='star' data-role='none' disabled='disabled' /> ";
			}						
		}
		$("#rating-stars").html(ratingStars + " </div>")
		$('input[type=radio].star').rating(); 
	}
	
	function sessionSuccessCallback(session) {
		

		$.mobile.hidePageLoadingMsg();
		var authors = getAuthors(session)
		$("#session-title").html("Session " + getFormattedDate(session.startTime, "ddd, dd mmm yyyy"))
		$("#detail-list").append(
				"<li data-role='list-divider'>" + session.startTimeShort
						+ " - " + session.endTimeShort + "</li>")
		$("#detail-list").append(
				"<li><h3><i>" + splitText(session.title, 32, '<br>') + "</i></h3>by: " + authors + "<p></li>")
		$("#detail-list").append("<li data-role='list-divider'>Location</li>")
		$("#detail-list").append(
				"<li>" + session.location.description + "<p class='ui-li-aside'>Max:"
						+ session.limit + "</p></li>")
		$("#detail-list").append(
				"<li data-role='list-divider'>Description</li>")
		$("#detail-list").append("<li>" + session.description + "</li>")
		$("#detail-list").append(
				"<li data-role='list-divider'>" + session.ratings.length + " Rating(s)</li>")
		renderRatings(session.ratings)
		$("#rate-button").append("<a href='#rate' data-role='button' data-rel='dialog' >Rate</a>")
		$("#rate-button").trigger("create"); 
		$("#detail-list").listview("refresh");
	}
	
	var LocalStorageAPI = {};
	LocalStorageAPI.confId = 'selectedConf'
	LocalStorageAPI.setConf = function(conf) {
		localStorage[this.confId] = JSON.stringify(conf)
	}
	LocalStorageAPI.getConf = function() {
		return JSON.parse(localStorage[this.confId])
	}
	LocalStorageAPI.getSession = function(sessId) {
		var slots = this.getConf().slots
		for(slotIndex in slots) {
			var sessions = slots[slotIndex].sessions
			for(sessionIndex in sessions) {
				var session = sessions[sessionIndex]
				if(session.id == sessId) {
					return session
				}
			}
		}
		return null
	}
	LocalStorageAPI.setSession = function(session) {
		var conf = this.getConf()
		var slots = conf.slots
		for(slotIndex in slots) {
			var sessions = slots[slotIndex].sessions
			for(sessionIndex in sessions) {
				var storedSession = sessions[sessionIndex]
				if(storedSession.id == session.id) {
					sessions[sessionIndex] = session
				}
			}
		}
		this.setConf(conf)
	}
	
	function printRatings(ratings) {
		if(ratings) {
			var total = ""	
			for(ratingIndex in ratings) {
				total += ratings[ratingIndex].rate + " "
			}
			return total		
		}
		return "empty";
	}
	
</script>
<script type="text/javascript" src="static/jquery.mobile-1.0.1.min.js"></script>
</head>
<body>


	<div data-role="page" id="login">

		<div data-role="header">
			<h1>Login</h1>
		</div>


		<div data-role="content">
			<form action="javascript: login();">
				<input id="username" type="text" placeholder="Your username" /> <input
					id="password" type="password" placeholder="Your password" />
				<button type="submit">Login</button>
			</form>
		</div>
	</div>

	<div data-role="page" id="conf">

		<div data-role="header">
			<h1><div id="conf-title"> XKE</div></h1>	
			<a href="#chooseConference" data-rel="dialog" class="ui-btn-right">XKEs</a>
		</div>


		<div data-role="content">
			<ul id="conf-list" data-role="listview" data-filter="true" />
		</div>
	</div>
		<div data-role="page" id="detail" >
		<div data-role="header">
			<h1 id="detailHeader"><div id="session-title">Session</div></h1>
<a href="#conf" data-rel="page" class="ui-btn-left" data-transition="fade">Back</a>
			<!-- 
		
data-add-back-btn="true"

			<a href="index.html" data-icon="check" class="ui-btn-right">Save</a>
		 -->
		</div>

		<div data-role="content">
			<ul id="detail-list" data-role="listview" />	
		</div>
		
		<br/><div id="rating-stars"></div><br/>
		<div id="rate-button">
		</div>

<!--		<div data-role="footer" data-position="fixed">
			<div data-role="navbar">
				<ul>
					<li><a href="#current">Current</a></li>
					<li><a href="#next" class="ui-btn-active">Next</a></li>
				</ul>
			</div>
		</div>
 -->
	</div>

	<div data-role="page" id="chooseConference">

		<div data-role="header">
			<h1 id="detailHeader">Choose a conference</h1>
		</div>
		<div data-role="content">
			<ul id="summary-list" data-role="listview" />
		</div>
	</div>

	<div data-role="page" id="rate">

		<div data-role="header">
			<h1 id="detailHeader">Rate</h1>
		</div>
		<div data-role="content">
		
		<form action="javascript: rate();">
			<div data-role="fieldcontain">
			<input type="number" data-type="range" name="slider" id="slider-0" value="0" min="0" max="10" data-highlight="true" track-theme="a" />
			
			</div>
			<button type="submit">Save</button>
			</form>
		</div>	
	</div>


</body>

</html>

