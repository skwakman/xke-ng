<!DOCTYPE html>
<html>
<head>
<title>Xebia Knowledge Exchange (NG)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="shortcut icon" href="images/netherlands_favicon.ico" type="image/x-icon" />

<link rel="stylesheet" href="static/jquery.mobile-1.0.1.min.css" />
<link rel="stylesheet" href="static/jquery.rating.css" />
<script type="text/javascript" src="static/jquery-1.6.4.min.js"></script>
<script type="text/javascript" src="static/jquery.rating.js"></script>
<script type="text/javascript" src="static/jquery.rating.pack.js"></script>
<script type="text/javascript" src="static/xkengmobile.js"></script>
<script type="text/javascript">
	
	GuiState = {};
	GuiState.currentSessionId;
	GuiState.currentConferenceId;
	GuiState.isNextConference = true;
	GuiState.forceSessionReload = false;

	function handleException(xhr, ajaxOptions, thrownError) {
		switch(xhr.status)
		{
		case 403:
			//alert("Please login")
			showLoginPage()
		  break;
		case 404:
			//alert("Cannot find requested object")
			changeToConferencePage(null, false)
		  break;
		default:
			alert("An unexpected error occured\nCode "
					+ xhr.status + "\nMessage "
					+ xhr.status);
			changeToConferencePage(null, false)
		}
	}
	$(document).bind("mobileinit", function(){
			$("#conf").live(
					"pageshow",
					function(event, ui) {
						cleanSessionDetails()
						ProxyAPI.loadConfById(GuiState.currentConferenceId, conferenceSuccessCallback)
					}),
			$("#detail").live(
					"pageshow",
					function(event, ui) {						
						ProxyAPI.loadSessionById(GuiState.currentSessionId, sessionSuccessCallback, GuiState.forceSessionReload)
						GuiState.forceSessionReload = false
				}),					
			$("#chooseConference").live(
					"pageshow",
					function(event, ui) {
						$.mobile.showPageLoadingMsg();
						ProxyAPI.loadConfSummary(3,5)
					})
	});

	function login() {
		$("#loginFailure").empty();
		var username = $("#username").val();
		var password = $("#password").val();
		ProxyAPI.login(username, password, loginSuccessCallback, loginFailureCallback)
	}
	
	function loginFailureCallback(xhr, ajaxOptions, thrownError) {
		if(xhr.status == 403) {
			$("#loginFailure").html("<p style='color:red'>You entered invalid credentials.<br>Please try again.</p>");
		} else {
			$("#loginFailure").html("<p style='color:red'>An unexpected error occured.\nStatus Code " + xhr.status + "\nMessage: " + thrownError + "\nTry again later.</p>");			
		}
	}
	
	function logout() {
		ProxyAPI.logout(showLoginPage)
	}

	 function rate() {
		 cleanSessionDetails()
		 GuiState.forceSessionReload = true
		 var rating = parseInt($("#slider-0").val())
		 ProxyAPI.rateSession(GuiState.currentSessionId, rating, showSessionDetailsPage)
	 }
	 

	function showLoginPage() {
		$.mobile.changePage("#login", {
			transition : "fade"
		});
	}	
	 
	function loginSuccessCallback(response) {
		$("#username").val("");
		$("#password").val("");
		$.mobile.changePage("#conf", {
			transition : "slidedown"
		});
	}
	
	function cleanSessionDetails() {
		$("#detail-list").empty()
		$("#rating-stars").empty()
		$("#rate-button").empty()		
		
	}

	function showSessionDetailsPage() {
		$.mobile.changePage("#detail", {
			transition : "slide"
		});
	}

	function changeToSessionDetailsPage(id) {
		GuiState.currentSessionId = id;
		 showSessionDetailsPage()
	}
	
	function selectConference() {
		$("#conf-list").empty();
		$.mobile.changePage("#chooseConference", {
			transition : "fade"
			
		});
	}
	
	function changeToConferencePage(id, next) {
		$("#summary-list").empty()
		GuiState.isNextConference = next
		GuiState.currentConferenceId = id
		$.mobile.changePage("#conf", {
			transition : "fade"
		});
	}

	function getAuthors(session) {
		var authors = ""
		for (authorIndex in session.authors) {
			if (authorIndex > 0) {
				authors += ", "
			}
			authors += session.authors[authorIndex].name
		}
		return authors;
	}

	function conferenceSummarySuccessCallback(conferences) {
		$.mobile.hidePageLoadingMsg();
		for (confIndex in conferences) {
			var conf = conferences[confIndex]
			var confTitle = getFormattedDate(conf.begin, "ddd, dd mmm yyyy") +  ' : '  + conf.title
			var next = false
			var liEl = "<li>"
			if(conf.next) {
				liEl = "<li data-theme='e'>"
				confTitle = "<i>" + confTitle + " </i><p class='ui-li-count'>NEXT</p>"
				next = true
			}
			$("#summary-list").append(
						liEl + "<a href='javascript:changeToConferencePage(\""
								+ conf.id + "\"," + next + ");'>" +confTitle +  "</a></li>")
		}
		$("#summary-list").listview("refresh");
	}
	
	function conferenceSuccessCallback(response) {
		GuiState.currentConferenceId = response.id
		$("#conf-list").empty()
		var confTitle = getFormattedDate(response.begin, "ddd, dd mmm yyyy") + ' : ' +response.title
		if(GuiState.isNextConference) {
			confTitle = 'NEXT: ' +  confTitle
		}
		$("#conf-title").html(confTitle)	
		for (slotIndex in response.slots) {
			var slot = response.slots[slotIndex]
			$("#conf-list").append(
					"<li data-role='list-divider'>" + slot.from + " - "
							+ slot.to + "</li>")
			for (sessionsIndex in slot.sessions) {
				var session = slot.sessions[sessionsIndex]
				var authors = getAuthors(session)
				$("#conf-list").append(
						"<li><a href='javascript:changeToSessionDetailsPage(\""
								+ session.id + "\");'><span><i>" + splitText(session.title, 32, '<br>')
								+ "</i></span><br><br><p>by: " + authors + "</p><span class='ui-li-aside'> "
								+ session.location.description + "&nbsp;&nbsp;&nbsp;</span></a></li>")
			}
		}
		$("#conf-list").listview("refresh");
	}


	function getRatingAverage(ratings) {
		if(ratings) {
			var total = 0	
			for(ratingIndex in ratings) {
				total += ratings[ratingIndex].rate
			}
			return parseInt(total / ratings.length);		
		}
		return 0;
	}

	function renderRatings(ratings) {
		var maxRating = 5
		var avgRating = Math.round(getRatingAverage(ratings) / 2)
		var ratingStars = "<div style='margin: auto 1.5em; display: inline-block;'>"
		for(var i = 0; i<maxRating; i++) {
			if(avgRating != 0 && i == (avgRating -1)) {
				ratingStars +="<input name='star1' type='radio' class='star' data-role='none' disabled='disabled' checked='checked' /> ";
			} else {
				ratingStars += "<input name='star1' type='radio' class='star' data-role='none' disabled='disabled' /> ";
			}						
		}
		$("#rating-stars").html(ratingStars + " </div>")
		$('input[type=radio].star').rating(); 
	}
	
	function sessionSuccessCallback(session) {
		$.mobile.hidePageLoadingMsg();
		var authors = getAuthors(session)
		$("#session-title").html(getFormattedDate(session.startTime, "ddd, dd mmm yyyy"))
		$("#detail-list").append(
				"<li data-role='list-divider'>" + session.startTimeShort
						+ " - " + session.endTimeShort + "</li>")
		$("#detail-list").append(
				"<li><h3><i>" + splitText(session.title, 32, '<br>') + "</i></h3>by: " + authors + "<p></li>")
		$("#detail-list").append("<li data-role='list-divider'>Location</li>")
		$("#detail-list").append(
				"<li>" + session.location.description + "<p class='ui-li-aside'>Max:"
						+ session.limit + "</p></li>")
		$("#detail-list").append(
				"<li data-role='list-divider'>Description</li>")
		$("#detail-list").append("<li>" + session.description + "</li>")
		$("#detail-list").append(
				"<li data-role='list-divider'>" + session.ratings.length + " Rating(s)</li>")
		renderRatings(session.ratings)
		$("#rate-button").append("<a href='#rate' data-role='button' data-rel='dialog' >Rate</a>")
		$("#rate-button").trigger("create"); 
		$("#detail-list").listview("refresh");
	}
	
	
</script>
<script type="text/javascript" src="static/jquery.mobile-1.0.1.min.js"></script>
</head>
<body>

	<div data-role="page" id="login">
		<div data-role="header">
			<h1>XKE Next Generation</h1>
		</div>
		<div data-role="content">
			<div id="loginFailure" ></div>
			<form action="javascript: login();">
				<input id="username" type="text" placeholder="Your username" /> <input
					id="password" type="password" placeholder="Your password" />
				<button type="submit">Login</button>
			</form>
		</div>
	</div>

	<div data-role="page" id="conf">

		<div data-role="header">
			<h1><span id="conf-title">XKE</span></h1>	
			<a href="javascript:logout();" data-rel="page" class="ui-btn-right" data-transition="fade">Logout</a>
			<a href="javascript:selectConference();" data-rel="dialog" class="ui-btn-left">XKEs</a>
		</div>
		<div data-role="content">
			<ul id="conf-list" data-role="listview" data-filter="true" />
		</div>
	</div>
	
	<div data-role="page" id="detail" >
		<div data-role="header">
			<h1 id="detailHeader"><span id="session-title">Session</span></h1>
			<a href="#conf" data-rel="page" class="ui-btn-left" data-transition="fade">Back</a>
		</div>
		<div data-role="content">
			<ul id="detail-list" data-role="listview" />	
		</div>
		<br/><div id="rating-stars"></div><br/>
		<div id="rate-button"></div>

<!--		<div data-role="footer" data-position="fixed">
			<div data-role="navbar">
				<ul>
					<li><a href="#current">Current</a></li>
					<li><a href="#next" class="ui-btn-active">Next</a></li>
				</ul>
			</div>
		</div>
 -->
	</div>

	<div data-role="dialog" id="chooseConference">
		<div data-role="header">
			<h1 id="detailHeader">Choose a conference</h1>
		</div>
		<div data-role="content">
			<ul id="summary-list" data-role="listview" />
		</div>
	</div>

	<div data-role="page" id="rate">
		<div data-role="header">
			<h1 id="detailHeader">Rate Session</h1>
		</div>
		<div data-role="content">
		<form action="javascript: rate();">
			<div data-role="fieldcontain">
			<input type="number" data-type="range" name="slider" id="slider-0" value="0" min="0" max="10" data-highlight="true"  />		
			</div>
			<button type="submit">Save</button>
			</form>
		</div>	
	</div>

</body>

</html>

