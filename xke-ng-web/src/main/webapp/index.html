<!DOCTYPE html>
<html>
<head>
<title>Xebia Knowledge Exchange (NG)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="shortcut icon" href="images/netherlands_favicon.ico" type="image/x-icon" />

<link rel="stylesheet" href="static/jquery.mobile-1.0.1.min.css" />
<link rel="stylesheet" href="static/jquery.rating.css" />
<script type="text/javascript" src="static/jquery-1.6.4.min.js"></script>
<script type="text/javascript" src="static/jquery.rating.js"></script>
<script type="text/javascript" src="static/jquery.rating.pack.js"></script>

<script type="text/javascript">
	//global state
	var currentSessionId;
	var currentConferenceId;
	var isNextConference = true;

	var dateFormat = function () {
		var	token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,
			timezone = /\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,
			timezoneClip = /[^-+\dA-Z]/g,
			pad = function (val, len) {
				val = String(val);
				len = len || 2;
				while (val.length < len) val = "0" + val;
				return val;
			};

		// Regexes and supporting functions are cached through closure
		return function (date, mask, utc) {
			var dF = dateFormat;

			// You can't provide utc if you skip other args (use the "UTC:" mask prefix)
			if (arguments.length == 1 && Object.prototype.toString.call(date) == "[object String]" && !/\d/.test(date)) {
				mask = date;
				date = undefined;
			}

			// Passing date through Date applies Date.parse, if necessary
			date = date ? new Date(date) : new Date;
			if (isNaN(date)) throw SyntaxError("invalid date");

			mask = String(dF.masks[mask] || mask || dF.masks["default"]);

			// Allow setting the utc argument via the mask
			if (mask.slice(0, 4) == "UTC:") {
				mask = mask.slice(4);
				utc = true;
			}

			var	_ = utc ? "getUTC" : "get",
				d = date[_ + "Date"](),
				D = date[_ + "Day"](),
				m = date[_ + "Month"](),
				y = date[_ + "FullYear"](),
				H = date[_ + "Hours"](),
				M = date[_ + "Minutes"](),
				s = date[_ + "Seconds"](),
				L = date[_ + "Milliseconds"](),
				o = utc ? 0 : date.getTimezoneOffset(),
				flags = {
					d:    d,
					dd:   pad(d),
					ddd:  dF.i18n.dayNames[D],
					dddd: dF.i18n.dayNames[D + 7],
					m:    m + 1,
					mm:   pad(m + 1),
					mmm:  dF.i18n.monthNames[m],
					mmmm: dF.i18n.monthNames[m + 12],
					yy:   String(y).slice(2),
					yyyy: y,
					h:    H % 12 || 12,
					hh:   pad(H % 12 || 12),
					H:    H,
					HH:   pad(H),
					M:    M,
					MM:   pad(M),
					s:    s,
					ss:   pad(s),
					l:    pad(L, 3),
					L:    pad(L > 99 ? Math.round(L / 10) : L),
					t:    H < 12 ? "a"  : "p",
					tt:   H < 12 ? "am" : "pm",
					T:    H < 12 ? "A"  : "P",
					TT:   H < 12 ? "AM" : "PM",
					Z:    utc ? "UTC" : (String(date).match(timezone) || [""]).pop().replace(timezoneClip, ""),
					o:    (o > 0 ? "-" : "+") + pad(Math.floor(Math.abs(o) / 60) * 100 + Math.abs(o) % 60, 4),
					S:    ["th", "st", "nd", "rd"][d % 10 > 3 ? 0 : (d % 100 - d % 10 != 10) * d % 10]
				};

			return mask.replace(token, function ($0) {
				return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1);
			});
		};
	}();

	// Some common format strings
	dateFormat.masks = {
		"default":      "ddd mmm dd yyyy HH:MM:ss",
		shortDate:      "m/d/yy",
		mediumDate:     "mmm d, yyyy",
		longDate:       "mmmm d, yyyy",
		fullDate:       "dddd, mmmm d, yyyy",
		shortTime:      "h:MM TT",
		mediumTime:     "h:MM:ss TT",
		longTime:       "h:MM:ss TT Z",
		isoDate:        "yyyy-mm-dd",
		isoTime:        "HH:MM:ss",
		isoDateTime:    "yyyy-mm-dd'T'HH:MM:ss",
		isoUtcDateTime: "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
	};

	// Internationalization strings
	dateFormat.i18n = {
		dayNames: [
			"Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat",
			"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"
		],
		monthNames: [
			"Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec",
			"January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
		]
	};

	// For convenience...
	Date.prototype.format = function (mask, utc) {
		return dateFormat(this, mask, utc);
	};

	
	Date.prototype.setISO8601 = function (string) {
	    var regexp = "([0-9]{4})(-([0-9]{2})(-([0-9]{2})" +
	        "(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\.([0-9]+))?)?" +
	        "(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?";
	    var d = string.match(new RegExp(regexp));

	    var offset = 0;
	    var date = new Date(d[1], 0, 1);

	    if (d[3]) { date.setMonth(d[3] - 1); }
	    if (d[5]) { date.setDate(d[5]); }
	    if (d[7]) { date.setHours(d[7]); }
	    if (d[8]) { date.setMinutes(d[8]); }
	    if (d[10]) { date.setSeconds(d[10]); }
	    if (d[12]) { date.setMilliseconds(Number("0." + d[12]) * 1000); }
	    if (d[14]) {
	        offset = (Number(d[16]) * 60) + Number(d[17]);
	        offset *= ((d[15] == '-') ? 1 : -1);
	    }

	    offset -= date.getTimezoneOffset();
	    time = (Number(date) + (offset * 60 * 1000));
	    this.setTime(Number(time));
	}
	
	function getFormattedDate(isoDateStr, format) {
		var date = toDate(isoDateStr)
		date.setISO8601(isoDateStr)
		return date.format(format);
	}
	
	function toDate(isoDateStr) {
		var date = new Date()
		date.setISO8601(isoDateStr)
		return date
	}
	
	function handleException(xhr, ajaxOptions, thrownError) {
		switch(xhr.status)
		{
		case 403:
			alert("Please login again")
			showLoginPage()
		  break;
		case 404:
			//alert("Cannot find requested object")
			changeToConferencePage(null, false)
		  break;
		default:
			alert("An unexpected error occured\nCode "
					+ xhr.status + "\nMessage "
					+ xhr.status);
			changeToConferencePage(null, false)
		}
	}
	
	
	$(document).bind("mobileinit", function(){
		//$.mobile.pageLoading();  
		//$(document).ready(
			$("#conf").live(
					"pageshow",
					function(event, ui) {
						if(currentConferenceId) {
							$.ajax({
								type : 'GET',
								dataType : 'json',
								contentType : 'application/json',
								url : '/xkeng/conference/'
										+ currentConferenceId + '/slots',
								success : conferenceSuccessCallback,
								crossDomain : false,
								error : handleException

						})
						} else {
							$.ajax({
								type : 'GET',
								dataType : 'json',
								contentType : 'application/json',
								url : '/xkeng/conference/next/1/slots',
								success : conferenceSuccessCallback,
								crossDomain : false,
								error : handleException
							})						
							
						}
					}),
			$("#detail").live(
					"pageshow",
					function(event, ui) {
						$.mobile.showPageLoadingMsg();
						cleanSessionDetails()
						$.ajax({
							type : 'GET',
							dataType : 'json',
							contentType : 'application/json',
							url : '/xkeng/session/' + currentSessionId,
							success : sessionSuccessCallback,
							crossDomain : false,
							error : handleException
						})
					}),					
					$("#chooseConference").live(
							"pageshow",
							function(event, ui) {
								$("#summary-list").empty()
								$.mobile.showPageLoadingMsg();
								$.ajax({
									type : 'GET',
									dataType : 'json',
									contentType : 'application/json',
									url : '/xkeng/conferences/summary/pastcount/3/futurecount/5',
									success : conferenceSummarySuccessCallback,
									crossDomain : false,
									error : handleException
								})
							})

	//);
							//$.mobile.pageLoading(true);  
	});


	function login() {
		var jsonRequest = {}
		jsonRequest.username = $("#username").val();
		jsonRequest.password = $("#password").val();
		$.ajax({
			type : 'POST',
			dataType : 'json',
			contentType : 'application/json',
			url : '/xkeng/login',
			success : loginSuccessCallback,
			crossDomain : false,
			data : JSON.stringify(jsonRequest),
			error : function(xhr, ajaxOptions, thrownError) {
				alert("Unable to post login\nCode " + xhr.status + "\nMessage "
						+ xhr.status);
			}
		});
	}

	 function rate() {
		var jsonRequest = {}
		jsonRequest.rate = parseInt($("#slider-0").val());
		$.ajax({
			type : 'POST',
			dataType : 'json',
			contentType : 'application/json',
			url : '/xkeng/feedback/' + currentSessionId + '/rating' ,
			success :  showSessionDetailsPage,
			crossDomain : false,
			data : JSON.stringify(jsonRequest),
			error : handleException
		});
	 }
	 

		function showLoginPage() {
			$.mobile.changePage("#login", {
				transition : "fade"
			});
		}	

	 
	function loginSuccessCallback(response) {
		$.mobile.changePage("#conf", {
			transition : "slidedown"
		});
	}

	
	function cleanSessionDetails() {
		$("#detail-list").empty()
		$("#rating-stars").empty()
		$("#rate-button").empty()		
		
	}

	function showSessionDetailsPage() {
		//cleanSessionDetails()
		$.mobile.changePage("#detail", {
			transition : "slide"
		});
	}

	function changeToSessionDetailsPage(id) {
		currentSessionId = id;
		 showSessionDetailsPage()
	}
	
	function changeToConferencePage(id, next) {
		isNextConference = next
		currentConferenceId = id
		$.mobile.changePage("#conf", {
			transition : "fade"
		});
	}

	function getAuthors(session) {
		var authors = ""
		for (authorIndex in session.authors) {
			if (authorIndex > 0) {
				authors += ", "
			}
			authors += session.authors[authorIndex].name
		}
		return authors;
	}

	function conferenceSummarySuccessCallback(conferences) {
		$.mobile.hidePageLoadingMsg();
		for (confIndex in conferences) {
			var conf = conferences[confIndex]
			var confTitle = getFormattedDate(conf.begin, "ddd, dd mmm yyyy") +  ' : '  + conf.title
			var next = false
			var liEl = "<li>"
			if(conf.next) {
				liEl = "<li data-theme='e'>"
				confTitle = "<i>" + confTitle + " </i><p class='ui-li-count'>NEXT</p>"
				next = true
			}
			$("#summary-list").append(
						liEl + "<a href='javascript:changeToConferencePage(\""
								+ conf.id + "\"," + next + ");'>" +confTitle +  "</a></li>")
		}
		$("#summary-list").listview("refresh");
	}
	
	function conferenceSuccessCallback(response) {
		
		$("#conf-list").empty()
		var confTitle = getFormattedDate(response.begin, "ddd, dd mmm yyyy") + ' : ' +response.title
		if(isNextConference) {
			confTitle = 'NEXT: ' +  confTitle
		}
		$("#conf-title").html(confTitle)	
		for (slotIndex in response.slots) {
			var slot = response.slots[slotIndex]
			$("#conf-list").append(
					"<li data-role='list-divider'>" + slot.from + " - "
							+ slot.to + "</li>")
			for (sessionsIndex in slot.sessions) {
				var session = slot.sessions[sessionsIndex]
				var authors = getAuthors(session)
				$("#conf-list").append(
						"<li><a href='javascript:changeToSessionDetailsPage(\""
								+ session.id + "\");'><span><i>" + splitText(session.title, 32, '<br>')
								+ "</i></span><br><br><p>by: " + authors + "</p><span class='ui-li-aside'> "
								+ session.location.description + "&nbsp;&nbsp;&nbsp;</span></a></li>")
			}
		}
		$("#conf-list").listview("refresh");
	}

	function splitText(text, chunkLength, separator) {
		if(text != null && text.length > chunkLength) {
			var finalText = ""
			var pattern = ".{1," + chunkLength + "}"
			var split = text.match(new RegExp(pattern, "gi"));
			for(splitIndex in split) {
				finalText += split[splitIndex] 
				if(splitIndex < (split.length -1)) {
					finalText += separator
				}
			}	
			return finalText
		}
		return text
	}
	
	function getRatingAverage(ratings) {
		if(ratings) {
			var total = 0	
			for(ratingIndex in ratings) {
				total += ratings[ratingIndex].rate
			}
			return parseInt(total / ratings.length);		
		}
		return 0;
	}

	function renderRatings(ratings) {
		var maxRating = 5
		var avgRating = getRatingAverage(ratings)
		if(avgRating > maxRating) {
			avgRating = avgRating % maxRating
		}
		var ratingStars = "<div style='margin: auto 1.5em; display: inline-block;'>"
		for(var i = 0; i<maxRating; i++) {
			if(avgRating != 0 && i == (avgRating -1)) {
				ratingStars +="<input name='star1' type='radio' class='star' data-role='none' disabled='disabled' checked='checked' /> ";
			} else {
				ratingStars += "<input name='star1' type='radio' class='star' data-role='none' disabled='disabled' /> ";
			}						
		}
		$("#rating-stars").html(ratingStars + " </div>")
		$('input[type=radio].star').rating(); 
	}
	
	function sessionSuccessCallback(session) {
		$.mobile.hidePageLoadingMsg();
		var authors = getAuthors(session)
		$("#session-title").html("Session " + getFormattedDate(session.startTime, "ddd, dd mmm yyyy"))
		$("#detail-list").append(
				"<li data-role='list-divider'>" + session.startTimeShort
						+ " - " + session.endTimeShort + "</li>")
		$("#detail-list").append(
				"<li><h3><i>" + splitText(session.title, 32, '<br>') + "</i></h3>by: " + authors + "<p></li>")
		$("#detail-list").append("<li data-role='list-divider'>Location</li>")
		$("#detail-list").append(
				"<li>" + session.location.description + "<p class='ui-li-aside'>Max:"
						+ session.limit + "</p></li>")
		$("#detail-list").append(
				"<li data-role='list-divider'>Description</li>")
		$("#detail-list").append("<li>" + session.description + "</li>")
		$("#detail-list").append(
				"<li data-role='list-divider'>" + session.ratings.length + " Rating(s)</li>")
		renderRatings(session.ratings)
		$("#rate-button").append("<a href='#rate' data-role='button' data-rel='dialog' >Rate</a>")
		$("#rate-button").trigger("create"); 
		$("#detail-list").listview("refresh");
	}
</script>
<script type="text/javascript" src="static/jquery.mobile-1.0.1.min.js"></script>
</head>
<body>


	<div data-role="page" id="login">

		<div data-role="header">
			<h1>Login</h1>
		</div>


		<div data-role="content">
			<form action="javascript: login();">
				<input id="username" type="text" placeholder="Your username" /> <input
					id="password" type="password" placeholder="Your password" />
				<button type="submit">Login</button>
			</form>
		</div>
	</div>

	<div data-role="page" id="conf">

		<div data-role="header">
			<h1><div id="conf-title"> XKE</div></h1>	
			<a href="#chooseConference" data-rel="dialog" class="ui-btn-right">XKEs</a>
		</div>


		<div data-role="content">
			<ul id="conf-list" data-role="listview" data-filter="true" />
		</div>
	</div>
		<div data-role="page" id="detail" >
		<div data-role="header">
			<h1 id="detailHeader"><div id="session-title">Session</div></h1>
<a href="#conf" data-rel="page" class="ui-btn-left" data-transition="fade">Back</a>
			<!-- 
		
data-add-back-btn="true"

			<a href="index.html" data-icon="check" class="ui-btn-right">Save</a>
		 -->
		</div>

		<div data-role="content">
			<ul id="detail-list" data-role="listview" />	
		</div>
		
		<br/><div id="rating-stars"></div><br/>
		<div id="rate-button">
		</div>

<!--		<div data-role="footer" data-position="fixed">
			<div data-role="navbar">
				<ul>
					<li><a href="#current">Current</a></li>
					<li><a href="#next" class="ui-btn-active">Next</a></li>
				</ul>
			</div>
		</div>
 -->
	</div>

	<div data-role="page" id="chooseConference">

		<div data-role="header">
			<h1 id="detailHeader">Choose a conference</h1>
		</div>
		<div data-role="content">
			<ul id="summary-list" data-role="listview" />
		</div>
	</div>

	<div data-role="page" id="rate">

		<div data-role="header">
			<h1 id="detailHeader">Rate</h1>
		</div>
		<div data-role="content">
		
		<form action="javascript: rate();">
			<div data-role="fieldcontain">
			<input type="number" data-type="range" name="slider" id="slider-0" value="0" min="0" max="5" data-highlight="true" track-theme="a" />
			
			</div>
			<button type="submit">Save</button>
			</form>
		</div>	
	</div>


</body>

</html>

